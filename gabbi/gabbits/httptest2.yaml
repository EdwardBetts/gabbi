# GET the tiddlers in the recipe (made up of bag0)
- name: Get recipe tiddlers
  url: /recipes/sample/tiddlers
  expected:
  - tiddler4
  - tiddler5

# GET one of those tiddlers from the recipe
- name: Get a tiddler in a recipe
  url: /recipes/sample/tiddlers/tiddler4
  expected:
  - i am tiddler 4

# GET the revisions of that tiddler
- name: get tiddler revisions
  url: /recipes/sample/tiddlers/tiddler4/revisions
  expected:
  - /recipes/sample/tiddlers/tiddler4/revisions.json
  - tiddler4/revisions/1

# GET a single revision of that tiddler
- name: get a revision of a tiddler
  url: /recipes/sample/tiddlers/tiddler4/revisions/1
  expected:
  - i am tiddler 4

# PUT a new tiddler. Because there is only one bag
# in the sample recipe, it will go to that bag. Otherwise
# some calculating is done to determine which bag.
- name: put a new tiddler
  method: PUT
  url: /recipes/sample/tiddlers/tiddler4
  request_headers:
    content-type: application/json
  data: '{"text":"i am a new revision of tiddler 4"}'
  status: 204
  response_headers:
    location: http://our_test_domain:8001/bags/bag0/tiddlers/tiddler4

# Check there is a revision 2
- name: get a 2nd revision of a tiddler
  url: /recipes/sample/tiddlers/tiddler4/revisions/2
  expected:
  - i am a new revision of tiddler 4

# Create a new bag, with a restrictive policy. 
- name: PUT a new bag, with a policy
  method: PUT
  url: /bags/bagsample
  request_headers:
    content-type: application/json
  data: '{"desc":"i am a sample bag", "policy":{"write":["ANY"],"create":["ANY"]}}'
  status: 204
  response_headers:
    location: http://our_test_domain:8001/bags/bagsample

# confirm that bag
- name: GET bagsample
  url: /bags/bagsample
  request_headers:
    accept: application/json
  expected:
  - i am a sample bag
  - '"write": ["ANY"]'

# When we try to write to a bag that we don't have permission
# for we will get a permission error.
- name: PUT a tiddler in a restricted bag, and fail
  method: PUT
  url: /bags/bagsample/tiddlers/tiddlersample
  request_headers:
    content-type: application/json
  data: '{"text": "i am tiddler sample"}'
  status: 403

# Write the bag, with a user.
- name: PUT a tiddler in a restricted bag, and succeed
  method: PUT
  url: /bags/bagsample/tiddlers/tiddlersample
  request_headers:
    Authorization: Basic Y2RlbnQ6Y293cGln
    content-type: application/json
  data: '{"text": "i am tiddler sample"}'
  status: 204

